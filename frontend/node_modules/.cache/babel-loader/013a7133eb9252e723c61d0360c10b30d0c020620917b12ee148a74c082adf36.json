{"ast":null,"code":"import { ref, onMounted, reactive } from 'vue';\nimport { ElMessage, ElMessageBox } from 'element-plus';\nimport { Picture } from '@element-plus/icons-vue';\nimport axios from 'axios';\nexport default {\n  name: 'MemberExchange',\n  components: {\n    Picture\n  },\n  setup() {\n    const products = ref([]);\n    const exchangeRecords = ref([]);\n    const memberInfo = reactive({\n      member: {}\n    });\n    const exchangingProductId = ref(null);\n    const productMap = ref(new Map());\n    const loadProducts = async () => {\n      try {\n        const response = await axios.get('/api/exchange/products');\n        if (response.data.code === 200) {\n          products.value = response.data.data;\n        }\n      } catch (error) {\n        ElMessage.error('获取商品列表失败');\n      }\n    };\n    const loadExchangeRecords = async () => {\n      try {\n        const response = await axios.get('/api/exchange/records');\n        if (response.data.code === 200) {\n          exchangeRecords.value = response.data.data;\n\n          // 构建商品映射\n          exchangeRecords.value.forEach(record => {\n            if (!productMap.value.has(record.productId)) {\n              productMap.value.set(record.productId, {\n                productName: '商品' + record.productId\n              });\n            }\n          });\n        }\n      } catch (error) {\n        console.error('获取兑换记录失败', error);\n      }\n    };\n    const loadMemberInfo = async () => {\n      try {\n        const response = await axios.get('/api/member/profile');\n        if (response.data.code === 200) {\n          memberInfo.member = response.data.data.member;\n        }\n      } catch (error) {\n        console.error('获取会员信息失败', error);\n      }\n    };\n    const handleExchange = async product => {\n      try {\n        await ElMessageBox.confirm(`确定要用 ${product.pointsRequired} 积分兑换 ${product.productName} 吗？`, '确认兑换', {\n          confirmButtonText: '确定',\n          cancelButtonText: '取消',\n          type: 'warning'\n        });\n        exchangingProductId.value = product.id;\n        const response = await axios.post('/api/exchange/exchange', {\n          productId: product.id\n        });\n        if (response.data.code === 200) {\n          ElMessage.success('兑换成功');\n\n          // 刷新数据\n          await loadProducts();\n          await loadExchangeRecords();\n          await loadMemberInfo();\n        } else {\n          ElMessage.error(response.data.message || '兑换失败');\n        }\n      } catch (error) {\n        if (error !== 'cancel') {\n          ElMessage.error(error.response?.data?.message || '兑换失败');\n        }\n      } finally {\n        exchangingProductId.value = null;\n      }\n    };\n    const getProductInfo = productId => {\n      return productMap.value.get(productId) || {\n        productName: '未知商品'\n      };\n    };\n    const formatTime = time => {\n      return new Date(time).toLocaleString();\n    };\n    onMounted(() => {\n      loadProducts();\n      loadExchangeRecords();\n      loadMemberInfo();\n    });\n    return {\n      products,\n      exchangeRecords,\n      memberInfo,\n      exchangingProductId,\n      handleExchange,\n      getProductInfo,\n      formatTime\n    };\n  }\n};","map":{"version":3,"names":["ref","onMounted","reactive","ElMessage","ElMessageBox","Picture","axios","name","components","setup","products","exchangeRecords","memberInfo","member","exchangingProductId","productMap","Map","loadProducts","response","get","data","code","value","error","loadExchangeRecords","forEach","record","has","productId","set","productName","console","loadMemberInfo","handleExchange","product","confirm","pointsRequired","confirmButtonText","cancelButtonText","type","id","post","success","message","getProductInfo","formatTime","time","Date","toLocaleString"],"sources":["/Users/libra520/JavaProject/repast-vip-system/frontend/src/views/member/Exchange.vue"],"sourcesContent":["<template>\n  <div class=\"exchange\">\n    <el-card>\n      <template #header>\n        <div class=\"card-header\">\n          <span>积分兑换</span>\n          <div class=\"points-display\">\n            可用积分：<span class=\"points-value\">{{ memberInfo.member?.availablePoints || 0 }}</span>\n          </div>\n        </div>\n      </template>\n\n      <!-- 商品列表 -->\n      <div class=\"products-grid\">\n        <div v-for=\"product in products\" :key=\"product.id\" class=\"product-card\">\n          <div class=\"product-image\">\n            <img v-if=\"product.imageUrl\" :src=\"product.imageUrl\" :alt=\"product.productName\" />\n            <div v-else class=\"no-image\">\n              <el-icon size=\"40\"><Picture /></el-icon>\n            </div>\n          </div>\n          <div class=\"product-info\">\n            <h3 class=\"product-name\">{{ product.productName }}</h3>\n            <p class=\"product-desc\">{{ product.description }}</p>\n            <div class=\"product-points\">\n              <span class=\"points-required\">{{ product.pointsRequired }}</span>\n              <span class=\"points-unit\">积分</span>\n            </div>\n            <div class=\"product-stock\">\n              库存：{{ product.stockQuantity }}\n            </div>\n            <el-button \n              type=\"primary\" \n              @click=\"handleExchange(product)\"\n              :disabled=\"product.stockQuantity <= 0 || (memberInfo.member?.availablePoints || 0) < product.pointsRequired\"\n              :loading=\"exchangingProductId === product.id\"\n            >\n              {{ product.stockQuantity <= 0 ? '已售罄' : (memberInfo.member?.availablePoints || 0) < product.pointsRequired ? '积分不足' : '立即兑换' }}\n            </el-button>\n          </div>\n        </div>\n      </div>\n\n      <div v-if=\"products.length === 0\" class=\"no-data\">\n        暂无可兑换商品\n      </div>\n    </el-card>\n\n    <!-- 兑换记录 -->\n    <el-card style=\"margin-top: 20px;\">\n      <template #header>\n        <div class=\"card-header\">\n          <span>我的兑换记录</span>\n          <el-button type=\"text\" @click=\"$router.push('/member/exchange-records')\">查看全部</el-button>\n        </div>\n      </template>\n      \n      <el-table :data=\"exchangeRecords\" style=\"width: 100%\">\n        <el-table-column prop=\"productName\" label=\"商品名称\" width=\"200\">\n          <template #default=\"scope\">\n            {{ getProductInfo(scope.row.productId)?.productName }}\n          </template>\n        </el-table-column>\n        <el-table-column prop=\"pointsUsed\" label=\"使用积分\" width=\"120\">\n          <template #default=\"scope\">\n            <span class=\"points-used\">-{{ scope.row.pointsUsed }}</span>\n          </template>\n        </el-table-column>\n        <el-table-column prop=\"receiveInfo\" label=\"领取信息\" />\n        <el-table-column prop=\"exchangeTime\" label=\"兑换时间\" width=\"180\">\n          <template #default=\"scope\">\n            {{ formatTime(scope.row.exchangeTime) }}\n          </template>\n        </el-table-column>\n      </el-table>\n\n      <div v-if=\"exchangeRecords.length === 0\" class=\"no-data\">\n        暂无兑换记录\n      </div>\n    </el-card>\n  </div>\n</template>\n\n<script>\nimport { ref, onMounted, reactive } from 'vue'\nimport { ElMessage, ElMessageBox } from 'element-plus'\nimport { Picture } from '@element-plus/icons-vue'\nimport axios from 'axios'\n\nexport default {\n  name: 'MemberExchange',\n  components: {\n    Picture\n  },\n  setup() {\n    const products = ref([])\n    const exchangeRecords = ref([])\n    const memberInfo = reactive({ member: {} })\n    const exchangingProductId = ref(null)\n    const productMap = ref(new Map())\n\n    const loadProducts = async () => {\n      try {\n        const response = await axios.get('/api/exchange/products')\n        if (response.data.code === 200) {\n          products.value = response.data.data\n        }\n      } catch (error) {\n        ElMessage.error('获取商品列表失败')\n      }\n    }\n\n    const loadExchangeRecords = async () => {\n      try {\n        const response = await axios.get('/api/exchange/records')\n        if (response.data.code === 200) {\n          exchangeRecords.value = response.data.data\n          \n          // 构建商品映射\n          exchangeRecords.value.forEach(record => {\n            if (!productMap.value.has(record.productId)) {\n              productMap.value.set(record.productId, {\n                productName: '商品' + record.productId\n              })\n            }\n          })\n        }\n      } catch (error) {\n        console.error('获取兑换记录失败', error)\n      }\n    }\n\n    const loadMemberInfo = async () => {\n      try {\n        const response = await axios.get('/api/member/profile')\n        if (response.data.code === 200) {\n          memberInfo.member = response.data.data.member\n        }\n      } catch (error) {\n        console.error('获取会员信息失败', error)\n      }\n    }\n\n    const handleExchange = async (product) => {\n      try {\n        await ElMessageBox.confirm(\n          `确定要用 ${product.pointsRequired} 积分兑换 ${product.productName} 吗？`,\n          '确认兑换',\n          {\n            confirmButtonText: '确定',\n            cancelButtonText: '取消',\n            type: 'warning'\n          }\n        )\n\n        exchangingProductId.value = product.id\n\n        const response = await axios.post('/api/exchange/exchange', {\n          productId: product.id\n        })\n\n        if (response.data.code === 200) {\n          ElMessage.success('兑换成功')\n          \n          // 刷新数据\n          await loadProducts()\n          await loadExchangeRecords()\n          await loadMemberInfo()\n        } else {\n          ElMessage.error(response.data.message || '兑换失败')\n        }\n      } catch (error) {\n        if (error !== 'cancel') {\n          ElMessage.error(error.response?.data?.message || '兑换失败')\n        }\n      } finally {\n        exchangingProductId.value = null\n      }\n    }\n\n    const getProductInfo = (productId) => {\n      return productMap.value.get(productId) || { productName: '未知商品' }\n    }\n\n    const formatTime = (time) => {\n      return new Date(time).toLocaleString()\n    }\n\n    onMounted(() => {\n      loadProducts()\n      loadExchangeRecords()\n      loadMemberInfo()\n    })\n\n    return {\n      products,\n      exchangeRecords,\n      memberInfo,\n      exchangingProductId,\n      handleExchange,\n      getProductInfo,\n      formatTime\n    }\n  }\n}\n</script>\n\n<style scoped>\n.exchange {\n  padding: 20px;\n}\n\n.card-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.points-display {\n  color: #666;\n}\n\n.points-value {\n  color: #409EFF;\n  font-weight: bold;\n  font-size: 18px;\n}\n\n.products-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));\n  gap: 20px;\n  margin-top: 20px;\n}\n\n.product-card {\n  border: 1px solid #e4e7ed;\n  border-radius: 8px;\n  overflow: hidden;\n  transition: box-shadow 0.3s;\n}\n\n.product-card:hover {\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n}\n\n.product-image {\n  width: 100%;\n  height: 200px;\n  background: #f5f7fa;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  overflow: hidden;\n}\n\n.product-image img {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n\n.no-image {\n  color: #c0c4cc;\n}\n\n.product-info {\n  padding: 15px;\n}\n\n.product-name {\n  margin: 0 0 10px 0;\n  font-size: 16px;\n  color: #303133;\n}\n\n.product-desc {\n  color: #606266;\n  font-size: 14px;\n  margin: 0 0 15px 0;\n  line-height: 1.5;\n  height: 42px;\n  overflow: hidden;\n  display: -webkit-box;\n  -webkit-line-clamp: 2;\n  -webkit-box-orient: vertical;\n}\n\n.product-points {\n  margin-bottom: 10px;\n}\n\n.points-required {\n  color: #f56c6c;\n  font-size: 24px;\n  font-weight: bold;\n}\n\n.points-unit {\n  color: #909399;\n  font-size: 14px;\n}\n\n.product-stock {\n  color: #909399;\n  font-size: 14px;\n  margin-bottom: 15px;\n}\n\n.points-used {\n  color: #f56c6c;\n  font-weight: bold;\n}\n\n.no-data {\n  text-align: center;\n  color: #909399;\n  padding: 40px;\n}\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}